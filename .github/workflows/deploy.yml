# .github/workflows/deploy.yml
name: Deploy Telegram Bot (Self-hosted EC2)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Pull latest changes
      run: |
        cd /home/ubuntu/telegram-bot
        git pull origin main

    - name: Activate venv & install dependencies
      run: |
        cd /home/ubuntu/telegram-bot
        source bot_env/bin/activate
        pip install -r requirements.txt

    - name: Restart bot service
      run: |
        sudo systemctl restart telegram-bot.service
        sleep 5
        sudo systemctl status telegram-bot.service
        sudo journalctl -u telegram-bot.service -n 10 --no-pager

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment status
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_NOTIFY_TOKEN }}
        message: |
          ğŸš€ **Deployment Status**: ${{ job.status }}
          
          ğŸ“ **Repository**: ${{ github.repository }}
          ğŸŒŸ **Branch**: ${{ github.ref_name }}
          ğŸ‘¤ **Author**: ${{ github.actor }}
          ğŸ’¬ **Commit**: ${{ github.event.head_commit.message }}
          â° **Time**: ${{ github.event.head_commit.timestamp }}
          ğŸ”— **Commit URL**: ${{ github.event.head_commit.url }}
